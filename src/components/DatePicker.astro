---
/**
 * Custom Date Picker Component
 * Inspired by premium calendar UIs with red/black brand colors
 * Features: month navigation, quick select shortcuts, visual selected state
 */
---

<div class="datepicker-field">
  <label for="datepicker-trigger" class="form-label">Preferred Date</label>
  <button type="button" id="datepicker-trigger" class="datepicker-trigger" aria-haspopup="dialog" aria-expanded="false">
    <span id="datepicker-display" class="datepicker-display">Select a date</span>
    <svg class="datepicker-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 2v4"></path>
      <path d="M16 2v4"></path>
      <rect width="18" height="18" x="3" y="4" rx="2"></rect>
      <path d="M3 10h18"></path>
    </svg>
  </button>
  <input type="hidden" id="date" name="date" required />
</div>

<!-- Date Picker Modal -->
<div id="datepicker-overlay" class="datepicker-overlay" role="dialog" aria-modal="true" aria-label="Choose a date">
  <div class="datepicker-panel" id="datepicker-panel">
    
    <!-- Sidebar - Quick Selects -->
    <div class="datepicker-sidebar">
      <div class="sidebar-title">Quick Select</div>
      <button type="button" class="sidebar-btn" data-quick="today">Today</button>
      <button type="button" class="sidebar-btn" data-quick="tomorrow">Tomorrow</button>
      <button type="button" class="sidebar-btn" data-quick="this-weekend">This Weekend</button>
      <button type="button" class="sidebar-btn" data-quick="next-week">Next Week</button>
      <button type="button" class="sidebar-btn" data-quick="next-month">Next Month</button>
    </div>

    <!-- Calendar Body -->
    <div class="datepicker-body">
      <!-- Header with month nav -->
      <div class="datepicker-header">
        <button type="button" class="nav-btn" id="dp-prev" aria-label="Previous month">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        </button>
        <div class="month-year" id="dp-month-year"></div>
        <button type="button" class="nav-btn" id="dp-next" aria-label="Next month">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
        </button>
      </div>

      <!-- Day labels -->
      <div class="datepicker-weekdays">
        <span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span>
      </div>

      <!-- Calendar grid -->
      <div class="datepicker-grid" id="dp-grid"></div>

      <!-- Actions -->
      <div class="datepicker-actions">
        <button type="button" class="dp-btn dp-cancel" id="dp-cancel">Cancel</button>
        <button type="button" class="dp-btn dp-apply" id="dp-apply">Apply</button>
      </div>
    </div>
  </div>
</div>

<style>
  /* === Trigger Button === */
  .datepicker-field {
    position: relative;
  }

  .datepicker-trigger {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.125rem 1.5rem;
    background: var(--color-white);
    border: 1.5px solid var(--color-mist);
    border-radius: var(--radius-md);
    color: var(--color-black);
    font-family: var(--font-body);
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s var(--ease-out-quint);
    text-align: left;
  }

  .datepicker-trigger:hover {
    border-color: var(--color-silver);
  }

  .datepicker-trigger:focus,
  .datepicker-trigger[aria-expanded="true"] {
    border-color: var(--color-red);
    box-shadow: 0 0 0 4px rgba(225, 29, 72, 0.08);
    outline: none;
  }

  .datepicker-display {
    flex: 1;
  }

  .datepicker-display.has-value {
    color: var(--color-black);
    font-weight: 500;
  }

  .datepicker-display:not(.has-value) {
    color: var(--color-gray);
  }

  .datepicker-icon {
    color: var(--color-gray);
    flex-shrink: 0;
    transition: color 0.3s ease;
  }

  .datepicker-trigger:focus .datepicker-icon,
  .datepicker-trigger[aria-expanded="true"] .datepicker-icon {
    color: var(--color-red);
  }

  /* === Overlay === */
  .datepicker-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    padding: 1rem;
  }

  .datepicker-overlay.open {
    opacity: 1;
    visibility: visible;
  }

  /* === Panel === */
  .datepicker-panel {
    display: flex;
    background: var(--color-white);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-2xl), 0 0 80px -20px rgba(225, 29, 72, 0.12);
    overflow: hidden;
    max-width: 540px;
    width: 100%;
    transform: translateY(16px) scale(0.98);
    transition: transform 0.35s var(--ease-out-expo);
  }

  .datepicker-overlay.open .datepicker-panel {
    transform: translateY(0) scale(1);
  }

  /* === Sidebar === */
  .datepicker-sidebar {
    width: 160px;
    background: var(--color-cloud);
    border-right: 1px solid var(--color-mist);
    padding: 1.5rem 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex-shrink: 0;
  }

  .sidebar-title {
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--color-gray);
    padding: 0 0.75rem;
    margin-bottom: 0.5rem;
  }

  .sidebar-btn {
    display: block;
    width: 100%;
    padding: 0.625rem 0.75rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-charcoal);
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    text-align: left;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: var(--font-body);
  }

  .sidebar-btn:hover {
    background: var(--color-mist);
    color: var(--color-black);
  }

  .sidebar-btn.active {
    background: var(--color-red);
    color: var(--color-white);
    font-weight: 600;
  }

  /* === Calendar Body === */
  .datepicker-body {
    flex: 1;
    padding: 1.5rem;
    min-width: 0;
  }

  /* === Header === */
  .datepicker-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.25rem;
  }

  .month-year {
    font-size: 1rem;
    font-weight: 700;
    color: var(--color-black);
    letter-spacing: -0.01em;
  }

  .nav-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: var(--radius-sm);
    border: 1.5px solid var(--color-mist);
    background: var(--color-white);
    color: var(--color-charcoal);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .nav-btn:hover {
    border-color: var(--color-red);
    color: var(--color-red);
    background: var(--color-red-muted);
  }

  /* === Weekday Labels === */
  .datepicker-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0;
    margin-bottom: 0.5rem;
  }

  .datepicker-weekdays span {
    text-align: center;
    font-size: 0.6875rem;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--color-gray);
    letter-spacing: 0.05em;
    padding: 0.375rem 0;
  }

  /* === Calendar Grid === */
  .datepicker-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
  }

  .datepicker-grid .dp-day {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    aspect-ratio: 1;
    font-size: 0.8125rem;
    font-weight: 500;
    border-radius: 50%;
    border: none;
    background: transparent;
    color: var(--color-black);
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: var(--font-body);
    position: relative;
  }

  .datepicker-grid .dp-day:hover:not(.disabled):not(.selected) {
    background: var(--color-red-muted);
    color: var(--color-red-dark);
  }

  .datepicker-grid .dp-day.today:not(.selected) {
    font-weight: 700;
    color: var(--color-red);
  }

  .datepicker-grid .dp-day.today:not(.selected)::after {
    content: '';
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 4px;
    background: var(--color-red);
    border-radius: 50%;
  }

  .datepicker-grid .dp-day.selected {
    background: var(--color-red);
    color: var(--color-white);
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(225, 29, 72, 0.35);
  }

  .datepicker-grid .dp-day.disabled {
    color: var(--color-silver);
    cursor: not-allowed;
    opacity: 0.4;
  }

  .datepicker-grid .dp-day.other-month {
    color: var(--color-silver);
  }

  /* === Actions === */
  .datepicker-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-top: 1.25rem;
    padding-top: 1.25rem;
    border-top: 1px solid var(--color-mist);
  }

  .dp-btn {
    padding: 0.625rem 1.5rem;
    font-size: 0.8125rem;
    font-weight: 600;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    font-family: var(--font-body);
    letter-spacing: 0.01em;
  }

  .dp-cancel {
    background: var(--color-cloud);
    color: var(--color-charcoal);
    border: 1.5px solid var(--color-mist);
  }

  .dp-cancel:hover {
    background: var(--color-mist);
    border-color: var(--color-silver);
  }

  .dp-apply {
    background: var(--color-red);
    color: var(--color-white);
  }

  .dp-apply:hover {
    background: var(--color-red-dark);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(225, 29, 72, 0.3);
  }

  .dp-apply:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  /* === Responsive === */
  @media (max-width: 600px) {
    .datepicker-panel {
      flex-direction: column;
      max-width: 360px;
    }

    .datepicker-sidebar {
      width: 100%;
      flex-direction: row;
      flex-wrap: wrap;
      padding: 0.75rem;
      border-right: none;
      border-bottom: 1px solid var(--color-mist);
      gap: 0.375rem;
    }

    .sidebar-title {
      width: 100%;
      margin-bottom: 0.25rem;
    }

    .sidebar-btn {
      flex: 0 0 auto;
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
      border: 1px solid var(--color-mist);
      border-radius: var(--radius-full);
    }

    .sidebar-btn.active {
      border-color: var(--color-red);
    }

    .datepicker-body {
      padding: 1rem;
    }

    .datepicker-grid .dp-day {
      font-size: 0.75rem;
    }
  }
</style>

<script>
  // ===== Custom Date Picker Logic =====
  const trigger = document.getElementById('datepicker-trigger') as HTMLButtonElement;
  const overlay = document.getElementById('datepicker-overlay') as HTMLDivElement;
  const panel = document.getElementById('datepicker-panel') as HTMLDivElement;
  const displayEl = document.getElementById('datepicker-display') as HTMLSpanElement;
  const hiddenInput = document.getElementById('date') as HTMLInputElement;
  const grid = document.getElementById('dp-grid') as HTMLDivElement;
  const monthYearEl = document.getElementById('dp-month-year') as HTMLDivElement;
  const prevBtn = document.getElementById('dp-prev') as HTMLButtonElement;
  const nextBtn = document.getElementById('dp-next') as HTMLButtonElement;
  const cancelBtn = document.getElementById('dp-cancel') as HTMLButtonElement;
  const applyBtn = document.getElementById('dp-apply') as HTMLButtonElement;
  const quickBtns = document.querySelectorAll('.sidebar-btn[data-quick]') as NodeListOf<HTMLButtonElement>;

  const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const today = new Date();
  today.setHours(0,0,0,0);

  let viewYear = today.getFullYear();
  let viewMonth = today.getMonth();
  let selectedDate: Date | null = null;
  let tempDate: Date | null = null; // holds selection before Apply

  function isDateDisabled(d: Date): boolean {
    const compare = new Date(d);
    compare.setHours(0,0,0,0);
    return compare < today;
  }

  function formatDate(d: Date): string {
    const opts: Intl.DateTimeFormatOptions = { weekday: 'short', day: 'numeric', month: 'long', year: 'numeric' };
    return d.toLocaleDateString('en-GB', opts);
  }

  function formatISO(d: Date): string {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  function isSameDay(a: Date, b: Date): boolean {
    return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
  }

  function renderCalendar() {
    monthYearEl.textContent = `${MONTHS[viewMonth]} ${viewYear}`;

    // First day of month
    const firstDay = new Date(viewYear, viewMonth, 1);
    const startDay = firstDay.getDay(); // 0=Sun

    // Days in month
    const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();

    // Days in previous month
    const daysInPrev = new Date(viewYear, viewMonth, 0).getDate();

    grid.innerHTML = '';

    // Previous month trailing days
    for (let i = startDay - 1; i >= 0; i--) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'dp-day other-month disabled';
      btn.textContent = String(daysInPrev - i);
      btn.disabled = true;
      grid.appendChild(btn);
    }

    // Current month days
    for (let d = 1; d <= daysInMonth; d++) {
      const date = new Date(viewYear, viewMonth, d);
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'dp-day';
      btn.textContent = String(d);

      if (isDateDisabled(date)) {
        btn.classList.add('disabled');
        btn.disabled = true;
      } else {
        btn.addEventListener('click', () => selectDay(date));
      }

      if (isSameDay(date, today)) {
        btn.classList.add('today');
      }

      if (tempDate && isSameDay(date, tempDate)) {
        btn.classList.add('selected');
      }

      grid.appendChild(btn);
    }

    // Next month leading days
    const totalCells = grid.children.length;
    const remaining = 42 - totalCells; // 6 rows Ã— 7 cols
    for (let i = 1; i <= remaining; i++) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'dp-day other-month disabled';
      btn.textContent = String(i);
      btn.disabled = true;
      grid.appendChild(btn);
    }

    // Update apply button state
    applyBtn.disabled = !tempDate;

    // Clear active sidebar buttons
    quickBtns.forEach(b => b.classList.remove('active'));
  }

  function selectDay(date: Date) {
    tempDate = new Date(date);
    renderCalendar();
  }

  function openPicker() {
    tempDate = selectedDate ? new Date(selectedDate) : null;
    if (selectedDate) {
      viewYear = selectedDate.getFullYear();
      viewMonth = selectedDate.getMonth();
    } else {
      viewYear = today.getFullYear();
      viewMonth = today.getMonth();
    }
    renderCalendar();
    overlay.classList.add('open');
    trigger.setAttribute('aria-expanded', 'true');
    document.body.style.overflow = 'hidden';
  }

  function closePicker() {
    overlay.classList.remove('open');
    trigger.setAttribute('aria-expanded', 'false');
    document.body.style.overflow = '';
  }

  function applySelection() {
    if (!tempDate) return;
    selectedDate = new Date(tempDate);
    hiddenInput.value = formatISO(selectedDate);
    displayEl.textContent = formatDate(selectedDate);
    displayEl.classList.add('has-value');
    closePicker();
  }

  // === Event Listeners ===

  trigger.addEventListener('click', openPicker);

  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closePicker();
  });

  cancelBtn.addEventListener('click', closePicker);
  applyBtn.addEventListener('click', applySelection);

  prevBtn.addEventListener('click', () => {
    viewMonth--;
    if (viewMonth < 0) { viewMonth = 11; viewYear--; }
    renderCalendar();
  });

  nextBtn.addEventListener('click', () => {
    viewMonth++;
    if (viewMonth > 11) { viewMonth = 0; viewYear++; }
    renderCalendar();
  });

  // Quick select buttons
  quickBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const quick = btn.dataset.quick;
      quickBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      let target: Date;
      switch (quick) {
        case 'today':
          target = new Date(today);
          break;
        case 'tomorrow': {
          target = new Date(today);
          target.setDate(target.getDate() + 1);
          break;
        }
        case 'this-weekend': {
          target = new Date(today);
          const dayOfWeek = target.getDay();
          const daysUntilSat = dayOfWeek === 6 ? 0 : (6 - dayOfWeek);
          target.setDate(target.getDate() + daysUntilSat);
          break;
        }
        case 'next-week': {
          target = new Date(today);
          const dow = target.getDay();
          const daysUntilMon = dow === 0 ? 1 : (8 - dow);
          target.setDate(target.getDate() + daysUntilMon);
          break;
        }
        case 'next-month': {
          target = new Date(today.getFullYear(), today.getMonth() + 1, 1);
          break;
        }
        default:
          return;
      }

      tempDate = target;
      viewYear = target.getFullYear();
      viewMonth = target.getMonth();
      renderCalendar();
    });
  });

  // Keyboard handling
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && overlay.classList.contains('open')) {
      closePicker();
    }
  });
</script>
