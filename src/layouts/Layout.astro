---
import '../styles/global.css';
import { t } from '../i18n/index';
import type { Locale } from '../i18n/config';
import BookingModal from '../components/BookingModal.astro';
import CookieConsent from '../components/CookieConsent.astro';

interface Props {
  title: string;
  description?: string;
  image?: string;
  imageAlt?: string;
  canonicalUrl?: string;
  lang?: Locale;
  noindex?: boolean;
  schema?: Record<string, unknown>;
}

const SITE_URL = 'https://ultimatebeautyspa.com';

const { 
  title, 
  description,
  image = `${SITE_URL}/og-image.jpg`,
  imageAlt = 'Ultimate Beauty Spa — Premium Spa & Beauty Services in Douala, Cameroon',
  canonicalUrl,
  lang = 'en',
  noindex = false,
  schema,
} = Astro.props;

const i = t(lang);
const metaDesc = description || i.site.description;
const siteName = "Ultimate Beauty Spa";

// Build proper title — avoid double brand name
const isHomepage = title === "Home" || title === "Accueil";
const hasBrandInTitle = title.includes('Ultimate Beauty Spa');
const fullTitle = isHomepage
  ? `${siteName} | ${i.site.tagline}`
  : hasBrandInTitle
    ? title
    : `${title} | ${siteName}`;

// Canonical URL
const currentPath = Astro.url.pathname;
const canonical = canonicalUrl || `${SITE_URL}${currentPath}`;

// Hreflang alternates
const altLang = lang === 'fr' ? 'en' : 'fr';
const pathWithoutLang = currentPath.replace(/^\/fr/, '') || '/';
const enUrl = `${SITE_URL}${pathWithoutLang}`;
const frUrl = `${SITE_URL}/fr${pathWithoutLang === '/' ? '' : pathWithoutLang}`;

// OG Image — ensure absolute
const ogImage = image.startsWith('http') ? image : `${SITE_URL}${image}`;

// Structured data: LocalBusiness (on every page for consistent NAP)
const businessSchema = {
  "@context": "https://schema.org",
  "@type": "HealthAndBeautyBusiness",
  "@id": `${SITE_URL}/#business`,
  "name": siteName,
  "description": i.site.description,
  "url": SITE_URL,
  "image": `${SITE_URL}/og-image.jpg`,
  "logo": `${SITE_URL}/images/logo.svg`,
  "priceRange": "XAF 2,000 – XAF 50,000",
  "currenciesAccepted": "XAF",
  "paymentAccepted": "Cash, Mobile Money",
  "telephone": "+237697113339",
  "email": "hello@ultimatebeautyspa.net",
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "Avant Saint James hôtel, Bonamoussadi",
    "addressLocality": "Douala",
    "addressRegion": "Littoral",
    "addressCountry": "CM"
  },
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": 4.0766,
    "longitude": 9.7236
  },
  "openingHoursSpecification": {
    "@type": "OpeningHoursSpecification",
    "dayOfWeek": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
    "opens": "09:00",
    "closes": "21:00"
  },
  "areaServed": {
    "@type": "City",
    "name": "Douala",
    "containedInPlace": {
      "@type": "Country",
      "name": "Cameroon"
    }
  },
  "hasOfferCatalog": {
    "@type": "OfferCatalog",
    "name": "Spa & Beauty Services",
    "itemListElement": [
      { "@type": "Offer", "itemOffered": { "@type": "Service", "name": "Massage & Relaxation" } },
      { "@type": "Offer", "itemOffered": { "@type": "Service", "name": "Wet Spa & Hydrotherapy" } },
      { "@type": "Offer", "itemOffered": { "@type": "Service", "name": "Face Care & Facials" } },
      { "@type": "Offer", "itemOffered": { "@type": "Service", "name": "Haircuts & Styling" } },
      { "@type": "Offer", "itemOffered": { "@type": "Service", "name": "Hair Coloring" } },
      { "@type": "Offer", "itemOffered": { "@type": "Service", "name": "Braiding, Locs & Protective Styles" } },
      { "@type": "Offer", "itemOffered": { "@type": "Service", "name": "Shaving & Beard Care" } },
      { "@type": "Offer", "itemOffered": { "@type": "Service", "name": "Manicure & Pedicure" } }
    ]
  },
  "sameAs": [
    "https://www.instagram.com/ultimatebeautyspa",
    "https://www.facebook.com/ultimatebeautyspa"
  ]
};

// WebSite schema (for sitelinks search)
const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": siteName,
  "url": SITE_URL,
  "inLanguage": [lang === 'fr' ? 'fr-CM' : 'en'],
  "potentialAction": {
    "@type": "SearchAction",
    "target": `${SITE_URL}/services?q={search_term_string}`,
    "query-input": "required name=search_term_string"
  }
};

// BreadcrumbList schema
const segments = currentPath.split('/').filter(Boolean);
const breadcrumbItems = [
  { "@type": "ListItem", "position": 1, "name": "Home", "item": SITE_URL }
];
let cumulativePath = '';
segments.forEach((seg, idx) => {
  cumulativePath += `/${seg}`;
  breadcrumbItems.push({
    "@type": "ListItem",
    "position": idx + 2,
    "name": seg.charAt(0).toUpperCase() + seg.slice(1).replace(/-/g, ' '),
    "item": `${SITE_URL}${cumulativePath}`
  });
});
const breadcrumbSchema = segments.length > 0 ? {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": breadcrumbItems
} : null;
---

<!DOCTYPE html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    
    <!-- Primary Meta Tags -->
    <title>{fullTitle}</title>
    <meta name="title" content={fullTitle} />
    <meta name="description" content={metaDesc} />
    <meta name="author" content={siteName} />
    {noindex && <meta name="robots" content="noindex, nofollow" />}
    
    <!-- Canonical URL -->
    <link rel="canonical" href={canonical} />
    
    <!-- Hreflang — Language Alternates -->
    <link rel="alternate" hreflang="en" href={enUrl} />
    <link rel="alternate" hreflang="fr" href={frUrl} />
    <link rel="alternate" hreflang="x-default" href={enUrl} />
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonical} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={metaDesc} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:alt" content={imageAlt} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:locale" content={lang === 'fr' ? 'fr_CM' : 'en_US'} />
    <meta property="og:locale:alternate" content={lang === 'fr' ? 'en_US' : 'fr_CM'} />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonical} />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={metaDesc} />
    <meta name="twitter:image" content={ogImage} />
    
    <!-- Geo Tags (GEO SEO) -->
    <meta name="geo.region" content="CM-LT" />
    <meta name="geo.placename" content="Douala" />
    <meta name="geo.position" content="4.0766;9.7236" />
    <meta name="ICBM" content="4.0766, 9.7236" />
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#E11D48" />
    
    <!-- Structured Data: LocalBusiness -->
    <script type="application/ld+json" set:html={JSON.stringify(businessSchema)} />
    
    <!-- Structured Data: WebSite -->
    {isHomepage && <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />}
    
    <!-- Structured Data: BreadcrumbList -->
    {breadcrumbSchema && <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />}
    
    <!-- Page-specific Structured Data -->
    {schema && <script type="application/ld+json" set:html={JSON.stringify(schema)} />}
  </head>
  
  <body class="min-h-screen flex flex-col">
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">
      {i.site.skipLink}
    </a>
    
    <slot name="header" />
    
    <main id="main-content" class="flex-1">
      <slot />
    </main>
    
    <slot name="footer" />
    
    <!-- Booking Modal -->
    <BookingModal lang={lang} />
    
    <!-- Cookie Consent -->
    <CookieConsent lang={lang} />
    
    <!-- Scroll Animations -->
    <script>
      // Intersection Observer for scroll animations
      const observerOptions = {
        root: null,
        rootMargin: '0px',
        threshold: 0.1
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            
            // Add animation class based on data attribute
            const el = entry.target as HTMLElement;
            const animation = el.dataset.animate;
            if (animation) {
              entry.target.classList.add(`animate-${animation}`);
            }
          }
        });
      }, observerOptions);

      // Observe all elements with data-animate attribute
      document.querySelectorAll('[data-animate]').forEach(el => {
        observer.observe(el);
      });
      
      // Smooth scroll for anchor links (skip booking modal links)
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (this: HTMLAnchorElement, e: Event) {
          const href = this.getAttribute('href');
          // Let booking modal handle its own links
          if (href === '#booking-modal' || this.hasAttribute('data-booking-modal')) return;
          e.preventDefault();
          if (href) {
            const target = document.querySelector(href);
            if (target) {
              target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
              });
            }
          }
        });
      });
    </script>
  </body>
</html>
